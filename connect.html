<!DOCTYPE html>
<html>
<head>
    <title>Wallet Connect</title>
    <script src="https://unpkg.com/@keplr-wallet/types@0.11.3/build/index.js"></script>
    <script src="https://unpkg.com/@injectivelabs/sdk-ts/dist/index.js"></script>
</head>
<body>
    <h1>Connect Your Wallet</h1>
    <button onclick="connectWallet()">Connect Keplr</button>
    <p id="status"></p>

    <script>
        const INJECTIVE_CHAIN_INFO = {
            chainId: 'injective-1',
            chainName: 'Injective',
            rpc: 'https://sentry.exchange.grpc-web.injective.network',
            rest: 'https://sentry.exchange.grpc-web.injective.network',
            bip44: {
                coinType: 60
            },
            bech32Config: {
                bech32PrefixAccAddr: "inj",
                bech32PrefixAccPub: "injpub",
                bech32PrefixValAddr: "injvaloper",
                bech32PrefixValPub: "injvaloperpub",
                bech32PrefixConsAddr: "injvalcons",
                bech32PrefixConsPub: "injvalconspub"
            },
            currencies: [{
                coinDenom: "INJ",
                coinMinimalDenom: "inj",
                coinDecimals: 18
            }],
            feeCurrencies: [{
                coinDenom: "INJ",
                coinMinimalDenom: "inj",
                coinDecimals: 18
            }],
            stakeCurrency: {
                coinDenom: "INJ",
                coinMinimalDenom: "inj",
                coinDecimals: 18
            },
            gasPriceStep: {
                low: 0.0000001,
                average: 0.0000025,
                high: 0.000004
            }
        };

        async function connectWallet() {
            const urlParams = new URLSearchParams(window.location.search);
            const telegram_user_id = urlParams.get('telegram_user_id');
            
            try {
                if (!window.keplr) {
                    document.getElementById('status').innerText = 'Please install Keplr!';
                    return;
                }

                // Add Injective chain to Keplr if not already added
                await window.keplr.experimentalSuggestChain(INJECTIVE_CHAIN_INFO);

                // Enable Injective chain
                await window.keplr.enable("injective-1");

                // Get the offline signer
                const offlineSigner = window.keplr.getOfflineSigner("injective-1");

                // Get user's Injective address
                const accounts = await offlineSigner.getAccounts();
                const account = accounts[0];
                
                // Get the public key
                const pubKey = await window.keplr.getKey("injective-1");
                
                // Convert address to Injective format if needed
                let injectiveAddress = account.address;
                if (!injectiveAddress.startsWith('inj')) {
                    const { bech32 } = await import('@injectivelabs/sdk-ts');
                    injectiveAddress = bech32.encode('inj', bech32.decode(account.address).data);
                }
                
                // Convert pubKey to base64 without using Buffer
                const pubKeyBase64 = btoa(String.fromCharCode.apply(null, pubKey.pubKey));
                
                // Send to backend - update URL to use window.location.origin
                const response = await fetch(window.location.origin + '/connect-wallet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        wallet_address: injectiveAddress,
                        telegram_user_id: telegram_user_id,
                        pub_key: {
                            type: pubKey.algo,
                            value: pubKeyBase64
                        }
                    }),
                });

                const result = await response.json();
                if (result.status === 'error') {
                    throw new Error(result.message);
                }

                document.getElementById('status').innerText = 'Connected! You can now return to Telegram.';
            } catch (error) {
                document.getElementById('status').innerText = 'Error connecting wallet: ' + error.message;
            }
        }

        function getTelegramUserId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('telegram_user_id');
        }
    </script>
</body>
</html> 